# åˆåŒé£é™©è¯†åˆ«ç³»ç»Ÿ - å…³é”®ä»£ç å®ç°æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **æ›´æ–°æ—¥æœŸ**: 2025-12-29  
> **é€‚ç”¨åœºæ™¯**: æ¯•ä¸šè®¾è®¡ç­”è¾©ã€ä»£ç è®²è§£

---

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ä¸€ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒå¼•æ“ ContractAnalyzer](#äºŒæ ¸å¿ƒå¼•æ“-contractanalyzer)
3. [è§„åˆ™å¼•æ“ RuleEngine](#ä¸‰è§„åˆ™å¼•æ“-ruleengine)
4. [LLM å®¢æˆ·ç«¯ LLMClient](#å››llm-å®¢æˆ·ç«¯-llmclient)
5. [æ··åˆæ£€ç´¢å™¨ HybridSearcher](#äº”æ··åˆæ£€ç´¢å™¨-hybridsearcher)
6. [å¼‚æ­¥å¹¶å‘æœºåˆ¶è¯¦è§£](#å…­å¼‚æ­¥å¹¶å‘æœºåˆ¶è¯¦è§£)

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ•°æ®æµ

```
ç”¨æˆ·ä¸Šä¼ åˆåŒ
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ–‡æœ¬é¢„å¤„ç†    â”‚ â”€â”€â–º â”‚    è§„åˆ™å¼•æ“     â”‚ â”€â”€â–º â”‚   LLM åˆ†æ      â”‚
â”‚  split_contract â”‚     â”‚  RuleEngine     â”‚     â”‚   LLMClient     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                       â”‚                       â”‚
      â”‚                       â”‚                       â”‚
      â–¼                       â–¼                       â–¼
  åˆ‡åˆ†ä¸ºæ¡æ¬¾            åŒ¹é…ä¸“å®¶è§„åˆ™            æ·±åº¦è¯­ä¹‰åˆ†æ
                       + æ£€ç´¢æ³•æ¡
                              â”‚
                              â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚   æŠ¥å‘Šç”Ÿæˆ      â”‚
                      â”‚  Markdown æ ¼å¼  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¨¡å—å…³ç³»

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | æ ¸å¿ƒèŒè´£ |
|------|----------|----------|
| **ContractAnalyzer** | `src/core/engine.py` | å·¥ä½œæµç¼–æ’ã€å¹¶å‘æ§åˆ¶ |
| **RuleEngine** | `src/core/rule_engine.py` | è§„åˆ™åŒ¹é…ã€æ³•æ¡æ£€ç´¢ |
| **LLMClient** | `src/core/llm.py` | LLM è°ƒç”¨ã€Prompt ç®¡ç† |
| **HybridSearcher** | `src/core/hybrid_searcher.py` | BM25 + Dense æ··åˆæ£€ç´¢ |

---

## äºŒã€æ ¸å¿ƒå¼•æ“ ContractAnalyzer

**æ–‡ä»¶ä½ç½®**: `src/core/engine.py`

### 2.1 ç±»ç»“æ„

```python
class ContractAnalyzer:
    def __init__(self):
        self.tracker = ProgressTracker()  # è¿›åº¦è¿½è¸ªå™¨
        self.rule_engine = RuleEngine()   # è§„åˆ™å¼•æ“
    
    async def analyze(self, job_id, text, llm_source, deep_reflection):
        """ä¸»åˆ†æå…¥å£ï¼ˆå¼‚æ­¥æ–¹æ³•ï¼‰"""
        pass
```

### 2.2 æ ¸å¿ƒæ–¹æ³• `analyze()` æµç¨‹

```python
async def analyze(self, job_id: str, text: str, llm_source: str = "local", 
                  deep_reflection: bool = False):
    """
    ä¸»åˆ†æå·¥ä½œæµï¼Œé‡‡ç”¨ asyncio å¹¶å‘å¤„ç†å¤šæ¡æ¬¾
    
    å‚æ•°:
        job_id: ä»»åŠ¡å”¯ä¸€æ ‡è¯†
        text: åˆåŒå…¨æ–‡
        llm_source: LLM æ¥æº ("local" æœ¬åœ° Ollama / "cloud" äº‘ç«¯)
        deep_reflection: æ˜¯å¦å¯ç”¨æ·±åº¦åæ€æ¨¡å¼
    """
```

#### æ­¥éª¤ 1ï¼šæ–‡æœ¬åˆ‡åˆ†

```python
# ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ‡åˆ†åˆåŒæ¡æ¬¾
clauses_text = split_contract(text)
# è¾“å‡ºç¤ºä¾‹: ["ç¬¬ä¸€æ¡ æœ¬åˆåŒ...", "ç¬¬äºŒæ¡ ç”²æ–¹åº”...", ...]
```

#### æ­¥éª¤ 2ï¼šå¹¶å‘æ§åˆ¶åˆå§‹åŒ–

```python
# ä»é…ç½®æ–‡ä»¶åŠ è½½æœ€å¤§å¹¶å‘æ•°
max_concurrency = config.get("system_config", {}).get("max_concurrency", 5)

# åˆ›å»ºä¿¡å·é‡ï¼ˆé™åˆ¶åŒæ—¶è¿è¡Œçš„ä»»åŠ¡æ•°ï¼‰
semaphore = asyncio.Semaphore(max_concurrency)
```

**åŸç†å›¾è§£**ï¼š
```
ä¿¡å·é‡ = 5 ä¸ªåé¢

ä»»åŠ¡é˜Ÿåˆ—: [æ¡æ¬¾1, æ¡æ¬¾2, æ¡æ¬¾3, æ¡æ¬¾4, æ¡æ¬¾5, æ¡æ¬¾6, æ¡æ¬¾7, ...]
              â†“       â†“       â†“       â†“       â†“
           [å ç”¨]   [å ç”¨]   [å ç”¨]   [å ç”¨]   [å ç”¨]  â† 5ä¸ªåé¢æ»¡
                                                        æ¡æ¬¾6, 7 ç­‰å¾…...
```

#### æ­¥éª¤ 3ï¼šå•æ¡æ¬¾å¤„ç†å‡½æ•°

```python
async def process_clause(i: int, clause_text: str):
    async with semaphore:  # è·å–ä¿¡å·é‡åé¢
        # 3a. è§„åˆ™åŒ¹é…
        reference_info, law_content, risk_id, confidence, match_source = \
            self.rule_engine.get_reference_info(clause_text)
        
        # 3b. LLM åˆ†æï¼ˆå¼‚æ­¥è°ƒç”¨ï¼‰
        clause_analysis = await asyncio.to_thread(
            llm_client.analyze_clause, 
            clause_text, 
            reference_info
        )
        
        # 3c. æ·±åº¦åæ€ï¼ˆå¯é€‰ï¼‰
        if deep_reflection and clause_analysis.risk_level == "é«˜":
            conclusion, reason = await asyncio.to_thread(
                llm_client.self_reflect,
                clause_analysis,
                reference_info
            )
            # æ ¹æ®åæ€ç»“æœè°ƒæ•´åˆ¤å®š
            if conclusion == "é™çº§":
                clause_analysis.risk_level = "ä½"
        
        return clause_analysis
```

#### æ­¥éª¤ 4ï¼šå¹¶è¡Œæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡

```python
# åˆ›å»ºæ‰€æœ‰æ¡æ¬¾çš„åˆ†æä»»åŠ¡
tasks = [process_clause(i, c) for i, c in enumerate(clauses_text)]

# å¹¶è¡Œæ‰§è¡Œï¼Œç­‰å¾…å…¨éƒ¨å®Œæˆ
results = await asyncio.gather(*tasks)
```

**æ‰§è¡Œæ—¶åºå¯¹æ¯”**ï¼š

```
ã€åŒæ­¥æ‰§è¡Œã€‘æ€»è€—æ—¶ = N Ã— å•æ¡è€—æ—¶
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
æ¡æ¬¾1 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] æ¡æ¬¾2 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] æ¡æ¬¾3 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] ...

ã€asyncio å¹¶å‘ã€‘æ€»è€—æ—¶ â‰ˆ ceil(N/5) Ã— å•æ¡è€—æ—¶
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
æ¡æ¬¾1 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
æ¡æ¬¾2 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
æ¡æ¬¾3 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
æ¡æ¬¾4 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
æ¡æ¬¾5 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
              â†‘ ç¬¬ä¸€æ‰¹å®Œæˆï¼Œå¼€å§‹ç¬¬äºŒæ‰¹
              æ¡æ¬¾6 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
              ...
```

---

## ä¸‰ã€è§„åˆ™å¼•æ“ RuleEngine

**æ–‡ä»¶ä½ç½®**: `src/core/rule_engine.py`

### 3.1 åŠŸèƒ½æ¦‚è¿°

è§„åˆ™å¼•æ“æ˜¯ç³»ç»Ÿçš„"ä¸“å®¶çŸ¥è¯†åº“"ï¼Œè´Ÿè´£ï¼š
1. **è§„åˆ™åŒ¹é…**ï¼šå°†æ¡æ¬¾ä¸ 107 æ¡ä¸“å®¶è§„åˆ™è¿›è¡ŒåŒ¹é…
2. **æ³•æ¡æ£€ç´¢**ï¼šä» SQLite æ•°æ®åº“æ£€ç´¢ç›¸å…³æ³•å¾‹æ¡æ–‡
3. **å…³é”®è¯å…œåº•**ï¼šå½“è§„åˆ™åº“æœªå‘½ä¸­æ—¶ï¼Œæ£€æµ‹é«˜å±å…³é”®è¯

### 3.2 æ ¸å¿ƒæ•°æ®ç»“æ„

**è§„åˆ™åº“æ ¼å¼** (`risk_rules.json`)ï¼š

```json
{
  "risk_id": "LABOR_001",
  "contract_type": "åŠ³åŠ¨åˆåŒ",
  "risk_name": "è¯•ç”¨æœŸè¿‡é•¿",
  "keywords": ["è¯•ç”¨æœŸ", "å…­ä¸ªæœˆ", "åŠå¹´"],
  "risk_type": "legal",
  "analysis_logic": "æ ¹æ®ã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹ï¼Œè¯•ç”¨æœŸæœ€é•¿ä¸å¾—è¶…è¿‡6ä¸ªæœˆ...",
  "laws": "ã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹ç¬¬åä¹æ¡"
}
```

### 3.3 åŒ¹é…æµç¨‹

```python
def match_risk(self, clause_text: str) -> Tuple[Optional[Dict], float, str]:
    """
    åŒ¹é…æ¡æ¬¾ä¸é£é™©è§„åˆ™
    
    è¿”å›: (åŒ¹é…çš„è§„åˆ™, ç½®ä¿¡åº¦, åŒ¹é…æ¥æº)
    åŒ¹é…æ¥æº: "rule_match" | "keyword_fallback" | "no_match"
    """
    
    # 1. é¢„å¤„ç†è¿‡æ»¤ï¼ˆæ’é™¤æ— å…³è§„åˆ™ï¼‰
    allowed_rules = preprocess_clause(clause_text, self.rules)
    
    # 2. æ··åˆæ£€ç´¢ï¼ˆBM25 + Denseï¼‰
    rule, score = self.searcher.search(clause_text, allowed_indices=...)
    
    # 3. é˜ˆå€¼åˆ¤æ–­
    if rule and score >= 0.7:
        return rule, score, "rule_match"
    
    # 4. å…³é”®è¯å…œåº•
    if self._keyword_fallback_check(clause_text):
        return None, 0.3, "keyword_fallback:æ£€æµ‹åˆ°çš„å…³é”®è¯"
    
    return None, 0.0, "no_match"
```

### 3.4 é«˜å±å…³é”®è¯å…œåº•

å½“è§„åˆ™åº“æœªåŒ¹é…æ—¶ï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ£€æµ‹é«˜å±æ¨¡å¼ï¼š

```python
HIGH_RISK_KEYWORDS = [
    r"ç”²æ–¹æœ‰æƒ.{0,10}(è§£é™¤|ç»ˆæ­¢|å˜æ›´|ä¿®æ”¹)",   # å•æ–¹æƒåˆ©
    r"(å…¨éƒ¨|ä¸€åˆ‡).{0,5}è´£ä»».{0,5}ç”±.{0,5}ä¹™æ–¹",  # è´£ä»»è½¬å«
    r"æœ€ç»ˆ.{0,5}è§£é‡Šæƒ",                         # æ ¼å¼æ¡æ¬¾
]
```

### 3.5 æ³•æ¡æ£€ç´¢

```python
def _search_law(self, laws_str: str) -> str:
    """
    ä» SQLite æ•°æ®åº“æ£€ç´¢æ³•æ¡åŸæ–‡
    
    ç¤ºä¾‹è¾“å…¥: "ã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹ç¬¬åä¹æ¡"
    ç¤ºä¾‹è¾“å‡º: "ã€åŠ³åŠ¨åˆåŒæ³• ç¬¬åä¹æ¡ã€‘åŠ³åŠ¨åˆåŒæœŸé™ä¸‰ä¸ªæœˆä»¥ä¸Š..."
    """
    # 1. è§£ææ³•å¾‹åç§°å’Œæ¡æ¬¾å·
    # 2. æŸ¥è¯¢ SQLite æ•°æ®åº“
    # 3. è¿”å›æ ¼å¼åŒ–çš„æ³•æ¡æ–‡æœ¬
```

---

## å››ã€LLM å®¢æˆ·ç«¯ LLMClient

**æ–‡ä»¶ä½ç½®**: `src/core/llm.py`

### 4.1 LLM è°ƒç”¨æ–¹å¼

**å½“å‰å®ç°**ï¼šä½¿ç”¨ `requests` åº“ç›´æ¥è°ƒç”¨ Ollama REST API

```python
def _call_ollama(self, prompt: str) -> str:
    """ç›´æ¥ HTTP è°ƒç”¨ Ollama API"""
    response = requests.post(
        f"{self.base_url}/api/generate",
        json={
            "model": self.model_name,      # "qwen3:4b-instruct"
            "prompt": prompt,
            "stream": False,
            "options": {"temperature": 0}
        },
        timeout=120
    )
    return response.json().get("response", "")
```

**ä¸ºä»€ä¹ˆä¸ç”¨ langchain_ollamaï¼Ÿ**
- `langchain_ollama` å†…éƒ¨ä½¿ç”¨ `httpx` åº“
- `httpx` ä¸ Ollama 0.13.5 å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼ˆè¿”å› 502 é”™è¯¯ï¼‰
- ç›´æ¥ä½¿ç”¨ `requests` å¯é¿å…æ­¤é—®é¢˜

### 4.2 æ ¸å¿ƒ Prompt è®¾è®¡

```python
MERGED_SCAN_PROMPT = """
ä½ æ˜¯èµ„æ·±åˆåŒå¾‹å¸ˆã€‚è¯·åŸºäºã€å‚è€ƒä¿¡æ¯ã€‘å¯¹ä»¥ä¸‹åˆåŒæ¡æ¬¾è¿›è¡Œåˆè§„å®¡æŸ¥ã€‚

### ğŸ“„ å¾…å®¡æ¡æ¬¾
{clause_text}

### ğŸ“š å‚è€ƒä¿¡æ¯ (å·²åŒ¹é…é£é™©åº“)
{reference_info}

### ğŸ“ å†™ä½œæŒ‡ä»¤
1. ã€ç›¸å…³æ€§å¼ºåˆ¶åˆ¤æ–­è§„åˆ™ã€‘
   è‹¥æ¡æ¬¾æœªå‡ºç°å‚è€ƒé£é™©ç‚¹çš„æ ¸å¿ƒåŠ¨è¯ï¼Œåˆ™è§†ä¸ºä¸ç›¸å…³ï¼Œåˆ¤å®šä¸ºä½é£é™©ã€‚
   
2. è‹¥å‚è€ƒä¿¡æ¯ç›¸å…³æ€§æˆç«‹ï¼šæ‰©å†™å‚è€ƒä¿¡æ¯çš„ä¸“å®¶é€»è¾‘ã€‚
3. è‹¥æ— å‚è€ƒä¿¡æ¯ï¼šåŸºäºå…¬å¹³åŸåˆ™ç®€è¦åˆ†æã€‚

### è¾“å‡ºæ ¼å¼
## é£é™©ï¼š[é£é™©ç®€è¿°]
- **ç­‰çº§**ï¼š[é«˜/ä½]
- **è¯æ®**ï¼š[ä»åŸæ–‡æ‘˜å½•]
- **åˆ†æ**ï¼š[è¯¦ç»†åˆ†æ]
- **æ³•æ¡**ï¼š[æ³•å¾‹ä¾æ®]
- **å»ºè®®**ï¼š[ä¿®æ”¹å»ºè®®]
"""
```

### 4.3 è‡ªåæ€æœºåˆ¶

```python
def self_reflect(self, analysis: ClauseAnalysis, reference_info: str):
    """
    å¯¹é«˜é£é™©åˆ¤å®šè¿›è¡ŒäºŒæ¬¡å®¡æŸ¥
    
    å®¡æŸ¥è¦ç‚¹:
    1. è¯æ®æ˜¯å¦ç¡®å®å­˜åœ¨äºæ¡æ¬¾åŸæ–‡ä¸­ï¼Ÿ
    2. åˆ†æé€»è¾‘æ˜¯å¦ä¸ä¸“å®¶è§„åˆ™ä¸€è‡´ï¼Ÿ
    3. æ˜¯å¦å­˜åœ¨è¿‡åº¦åˆ¤å®šï¼Ÿ
    
    è¿”å›: ("ç»´æŒ"/"é™çº§"/"å­˜ç–‘", ç†ç”±)
    """
```

**è‡ªåæ€æµç¨‹**ï¼š
```
åˆæ¬¡åˆ†æ: "é«˜é£é™©" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
                                                 â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   è‡ªåæ€ Prompt         â”‚
                                    â”‚   "è¯·å®¡æŸ¥è¿™ä¸ªåˆ†æ..."   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â–¼            â–¼                       â–¼
                     [ç»´æŒ]       [é™çº§]                  [å­˜ç–‘]
                        â”‚            â”‚                       â”‚
                        â–¼            â–¼                       â–¼
                    ä¿æŒé«˜é£é™©   æ”¹ä¸ºä½é£é™©            æ ‡è®°äººå·¥å¤æ ¸
```

---

## äº”ã€æ··åˆæ£€ç´¢å™¨ HybridSearcher

**æ–‡ä»¶ä½ç½®**: `src/core/hybrid_searcher.py`

### 5.1 åŒè·¯å¬å›æ¶æ„

```
                    æ¡æ¬¾æ–‡æœ¬
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Dense æ£€ç´¢    â”‚         â”‚   Sparse æ£€ç´¢   â”‚
â”‚  (BGE è¯­ä¹‰å‘é‡) â”‚         â”‚  (BM25 å…³é”®è¯)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â–¼                           â–¼
    ä½™å¼¦ç›¸ä¼¼åº¦                   TF-IDF åˆ†æ•°
    (0.0 ~ 1.0)               (å½’ä¸€åŒ–åˆ° 0~1)
         â”‚                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  åŠ æƒèåˆ    â”‚
              â”‚ Î±Ã—Dense     â”‚
              â”‚ +(1-Î±)Ã—Sparseâ”‚
              â”‚  (Î±=0.7)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
                æœ€ç»ˆæ’åº
```

### 5.2 æ ¸å¿ƒä»£ç 

```python
def search(self, query: str, alpha: float = 0.7) -> Tuple[Optional[Dict], float]:
    """
    æ··åˆæ£€ç´¢
    
    å‚æ•°:
        query: æ¡æ¬¾åŸæ–‡
        alpha: Dense æƒé‡ (é»˜è®¤ 0.7)
    """
    # 1. Dense æ£€ç´¢ (è¯­ä¹‰ç›¸ä¼¼åº¦)
    query_embedding = self.encoder.encode(query, normalize_embeddings=True)
    dense_scores = np.dot(self.rule_embeddings, query_embedding)
    
    # 2. Sparse æ£€ç´¢ (BM25)
    tokenized_query = list(jieba.cut(query))
    sparse_scores = self.bm25.get_scores(tokenized_query)
    
    # 3. å½’ä¸€åŒ– Sparse åˆ†æ•°
    sparse_scores = (sparse_scores - min) / (max - min)
    
    # 4. åŠ æƒèåˆ
    hybrid_scores = alpha * dense_scores + (1 - alpha) * sparse_scores
    
    # 5. é˜ˆå€¼è¿‡æ»¤ (0.7)
    best_idx = np.argmax(hybrid_scores)
    if hybrid_scores[best_idx] < 0.7:
        return None, hybrid_scores[best_idx]
    
    return self.rules[best_idx], hybrid_scores[best_idx]
```

### 5.3 ä¸ºä»€ä¹ˆéœ€è¦æ··åˆæ£€ç´¢ï¼Ÿ

| åœºæ™¯ | çº¯è¯­ä¹‰æ£€ç´¢é—®é¢˜ | çº¯å…³é”®è¯é—®é¢˜ | æ··åˆæ£€ç´¢ä¼˜åŠ¿ |
|------|---------------|-------------|-------------|
| "ç¬¬500æ¡ vs ç¬¬501æ¡" | éš¾ä»¥åŒºåˆ† | âœ… ç²¾ç¡®åŒ¹é… | ç»“åˆä¸¤è€…ä¼˜åŠ¿ |
| "è¿çº¦é‡‘è¿‡é«˜" vs "æƒ©ç½šæ€§æ¡æ¬¾" | âœ… è¯­ä¹‰ç†è§£ | å…³é”®è¯ä¸åŒ¹é… | ç»“åˆä¸¤è€…ä¼˜åŠ¿ |
| ä¸“ä¸šæœ¯è¯­å˜ä½“ | âœ… èƒ½è¯†åˆ« | å¯èƒ½é—æ¼ | æ›´é²æ£’ |

---

## å…­ã€å¼‚æ­¥å¹¶å‘æœºåˆ¶è¯¦è§£

### 6.1 æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ | è¯´æ˜ | ä»£ç ç¤ºä¾‹ |
|------|------|----------|
| `async def` | å®šä¹‰å¼‚æ­¥å‡½æ•° | `async def analyze(...)` |
| `await` | ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ | `await asyncio.gather(...)` |
| `asyncio.gather` | å¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡ | `results = await asyncio.gather(*tasks)` |
| `asyncio.Semaphore` | é™åˆ¶å¹¶å‘æ•°é‡ | `semaphore = asyncio.Semaphore(5)` |
| `asyncio.to_thread` | å°†åŒæ­¥å‡½æ•°è½¬ä¸ºå¼‚æ­¥ | `await asyncio.to_thread(sync_func)` |

### 6.2 æœ¬é¡¹ç›®ä¸­çš„åº”ç”¨

```python
# å®Œæ•´å¹¶å‘æ§åˆ¶ç¤ºä¾‹
async def analyze(self, ...):
    # 1. åˆ›å»ºä¿¡å·é‡
    semaphore = asyncio.Semaphore(5)
    
    # 2. å®šä¹‰å•æ¡æ¬¾å¤„ç†å‡½æ•°
    async def process_clause(clause):
        async with semaphore:  # è‡ªåŠ¨è·å–/é‡Šæ”¾åé¢
            # è°ƒç”¨ LLMï¼ˆåŒæ­¥å‡½æ•°è½¬å¼‚æ­¥ï¼‰
            result = await asyncio.to_thread(llm_client.analyze, clause)
            return result
    
    # 3. åˆ›å»ºæ‰€æœ‰ä»»åŠ¡
    tasks = [process_clause(c) for c in clauses]
    
    # 4. å¹¶è¡Œæ‰§è¡Œ
    results = await asyncio.gather(*tasks)
```

### 6.3 æ€§èƒ½å¯¹æ¯”

å‡è®¾ï¼š10 ä¸ªæ¡æ¬¾ï¼Œæ¯ä¸ª LLM è°ƒç”¨è€—æ—¶ 5 ç§’

| æ‰§è¡Œæ–¹å¼ | æ€»è€—æ—¶ | è®¡ç®—å…¬å¼ |
|----------|--------|----------|
| åŒæ­¥ä¸²è¡Œ | 50 ç§’ | 10 Ã— 5s |
| asyncio å¹¶å‘ (5å¹¶å‘) | 10 ç§’ | ceil(10/5) Ã— 5s |
| asyncio å¹¶å‘ (10å¹¶å‘) | 5 ç§’ | ceil(10/10) Ã— 5s |

---

## é™„å½•ï¼šæŠ€æœ¯å†³ç­–è¯´æ˜

### A. ä¸ºä»€ä¹ˆä¸ç”¨ LangGraphï¼Ÿ

| å› ç´  | asyncio (å½“å‰) | LangGraph |
|------|---------------|-----------|
| å­¦ä¹ æˆæœ¬ | ä½ | é«˜ |
| ä»£ç é‡ | ~250 è¡Œ | ~400+ è¡Œ |
| è°ƒè¯•éš¾åº¦ | ç®€å• | éœ€ LangSmith |
| é€‚ç”¨åœºæ™¯ | å›ºå®šæµç¨‹ | å¤æ‚åˆ†æ”¯ |

**ç»“è®º**ï¼šæœ¬é¡¹ç›®æµç¨‹å›ºå®šï¼Œasyncio è¶³å¤Ÿä¸”æ›´é«˜æ•ˆã€‚

### B. ä¸ºä»€ä¹ˆä½¿ç”¨ requests è€Œé langchain_ollamaï¼Ÿ

- `langchain_ollama` ä½¿ç”¨ `httpx`
- `httpx` ä¸ Ollama 0.13.5 å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ (502 é”™è¯¯)
- `requests` æ— æ­¤é—®é¢˜ï¼Œæ›´ç¨³å®š

---

*æ–‡æ¡£ç»“æŸ*
