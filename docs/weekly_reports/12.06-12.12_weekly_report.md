# 📅 第九阶段：技术审查与工程化优化 (12.06 - 12.12)

**核心目标**：完成项目代码库的系统性技术审查，识别并修复低风险技术债务，夯实法律知识库基础设施。

**最大提升**：形成了完整的技术审查报告 `Review.md`，为后续迭代提供了明确的优化路线图；同时完成了四项工程化改进，提升了系统的可维护性与安全性。

---

## 31. 技术审查与债务治理 (Technical Review & Debt Governance)

本周对项目代码库进行了全面的技术审查，系统性梳理了架构设计、代码质量、可维护性等维度的问题，并形成了优先级分明的改进计划。

### 1.1 多维度技术评估

- **架构成熟度 (4/5)**：采用 Streamlit + FastAPI + LangGraph 分层架构，模块职责清晰。但 LangGraph 作为核心编排引擎的优势未充分发挥。
- **技术选型合理性 (4/5)**：混合检索策略针对法条精确查询的痛点设计巧妙，本地/云端模型切换的灵活性值得肯定。
- **代码质量 (3/5)**：函数职责明确，但缺少类型注解约束、单元测试覆盖率低、部分模块耦合较深。
- **可维护性 (3/5)**：配置管理到位，但存在硬编码路径、缺乏依赖注入机制等问题。

### 1.2 风险分级与优先级排序

识别出影响系统稳定性和可迁移性的关键问题，按优先级分类如下：

| 优先级 | 问题 | 影响范围 |
|-------|------|---------|
| **P0** | 评测脚本调用不存在的 API 方法 | 评测系统完全瘫痪 |
| **P0** | CORS 配置允许任意来源 | 生产环境安全风险 |
| **P1** | ProgressTracker 无内存回收 | 长时间运行内存泄漏 |
| **P1** | 混合检索阈值硬编码 | 无法灵活调参 |
| **P2** | LLM 输出正则解析脆弱 | 召回率下降 |

### 1.3 优化路线图制定

基于审查结论，制定了分阶段执行的改进路线图，确保每一阶段的改动都是安全、可控、可回滚的。

---

## 32. 低风险工程化优化 (Low-Risk Engineering Optimizations)

本周完成了四项不影响核心业务逻辑的工程化改进，在保持系统稳定的前提下提升了代码质量。

### 2.1 评测脚本 API 修复

- **问题定位**：`evaluation/run_benchmark.py` 调用了不存在的 `llm_client.scan_chunk()` 方法，导致评测流程无法执行。
- **修复方案**：改为调用正确的 `analyze_clause()` 方法，并集成 `RuleEngine` 获取参考信息，与主分析流程保持一致。
- **附加优化**：结果文件名添加时间戳（如 `results_20251212_171900.json`），避免覆盖历史评测结果，便于横向对比。

### 2.2 CORS 安全加固

- **问题定位**：`src/api/main.py` 中硬编码 `allow_origins=["*"]`，在生产环境下存在跨站请求伪造风险。
- **修复方案**：改为从环境变量 `CORS_ORIGINS` 动态读取允许的域名列表，默认仅允许 `localhost:9000` 和 `localhost:8501`。
- **部署指南**：生产环境可通过 `export CORS_ORIGINS="https://yourdomain.com"` 进行配置。

### 2.3 ProgressTracker 内存治理

- **问题定位**：任务队列 `_jobs` 字典无清理机制，长时间运行后已完成任务持续堆积，造成内存泄漏。
- **修复方案**：引入 TTL (Time-To-Live) 机制，设定 `TTL_SECONDS = 1800`（30分钟），在每次查询状态时自动清理过期任务。
- **实现细节**：新增 `_cleanup_expired()` 私有方法，在 `get_status()` 中触发，无需额外的定时任务。

### 2.4 配置外部化

- **问题定位**：`hybrid_searcher.py` 中的融合权重 `alpha=0.7` 和相似度阈值 `0.4` 硬编码，无法根据不同场景灵活调整。
- **修复方案**：在 `configs/config.yaml` 中新增 `hybrid_search_config` 配置段，检索器初始化时自动加载配置值。
- **可调参数**：`alpha`（Dense/Sparse 权重比）、`threshold`（相似度过滤阈值）。

---

## 33. 法律知识库扩充 (Legal Knowledge Base Expansion)

本周对法律条文库进行了大规模扩充与结构化治理，显著提升了系统的法律依据覆盖能力。

### 3.1 法律文本收集与清洗

- **数据源**：从官方渠道获取了 27 部核心法律法规的全文文本。
- **清洗流程**：手动剔除无效章节标题、格式噪音、重复段落，确保每条法条都是干净、可检索的。
- **存储位置**：`Evaldata/processed_laws/` 目录，采用统一的 `.txt` 格式存储。

### 3.2 法律领域覆盖

| 领域 | 法律文件 |
|-----|---------|
| **劳动用工** | 劳动法、劳动合同法、劳动合同法实施条例、劳动争议调解仲裁法、工伤保险条例、工资支付暂行规定、职工带薪年休假条例、最低工资规定 |
| **民事通用** | 民法典、民事诉讼法、仲裁法、诉讼费用交纳办法 |
| **消费权益** | 消费者权益保护法、部分商品修理更换退货责任规定、反不正当竞争法 |
| **房屋租赁** | 商品房屋租赁管理办法 |
| **电子商务** | 电子商务法、电子签名法、个人信息保护法 |
| **招投标** | 招标投标法 |
| **金融借贷** | 最高人民法院关于审理民间借贷案件适用法律若干问题的规定 |

### 3.3 数据库导入与索引

- **导入脚本**：使用 `import_processed_laws.py` 将清洗后的法条批量导入 SQLite 数据库。
- **结构化存储**：每条法条包含 `law_name`（法律名称）、`article`（条款编号）、`content`（条款原文）、`tags`（分类标签）。
- **检索优化**：建立了法条名称 + 条款编号的复合索引，支持精确查询与后缀匹配。

---

## 34. 代码质量提升 (Code Quality Improvements)

### 4.1 文件修改清单

| 文件 | 修改类型 | 变更说明 |
|-----|---------|---------|
| `evaluation/run_benchmark.py` | Bug Fix | 修复 API 调用错误，添加时间戳 |
| `src/api/main.py` | 安全加固 | CORS 配置环境化 |
| `src/utils/progress_tracker.py` | 功能增强 | 添加 TTL 过期清理机制 |
| `src/core/hybrid_searcher.py` | 配置外部化 | 阈值参数从配置加载 |
| `configs/config.yaml` | 配置新增 | 添加 `hybrid_search_config` 配置段 |

### 4.2 新增配置项

```yaml
# configs/config.yaml
hybrid_search_config:
  alpha: 0.7      # Dense Score 权重
  threshold: 0.4  # 相似度阈值
```

---

## 35. 下一阶段展望

基于本阶段完成的技术审查与基础设施建设，下一阶段将聚焦于以下方向：

### 5.1 规划方向

- **结构化输出升级**：引入 LangChain PydanticOutputParser，替代脆弱的正则解析，提升 LLM 输出解析的鲁棒性。
- **单元测试覆盖**：为核心模块（`HybridSearcher`、`RuleEngine`、`ClauseClassifier`）补充单元测试，建立回归测试机制。
- **LangGraph 工作流重构**：将当前的 `asyncio.gather` 并行模式升级为 LangGraph `StateGraph`，实现条件分支与可观测性。
- **前端代码重构**：将 `app.py` 中超过 170 行的内联 CSS 抽取到独立样式文件，提升可维护性。

### 5.2 预计工时

| 任务 | 预计工时 | 优先级 |
|-----|---------|-------|
| PydanticOutputParser 集成 | 2天 | P1 |
| 核心模块单元测试 | 2天 | P2 |
| CSS 样式文件抽取 | 0.5天 | P2 |
| LangGraph 工作流重构 | 5-7天 | P3 |

